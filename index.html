<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 2568</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    header {
      padding: 12px 16px;
      background: #1f2937;
      color: #fff;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .filter-group label {
      font-size: 11px;
      color: #e5e7eb;
    }
    .filter-group input,
    .filter-group select,
    .filter-group button {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #9ca3af;
    }
    .filter-group button {
      border: none;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
    .filter-group button.secondary {
      background: #6b7280;
    }

    #map {
      width: 100%;
      height: calc(100vh - 70px);
    }

    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.4;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 3px;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #4b5563;
    }

    .status-bar {
      position: absolute;
      z-index: 500;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(31,41,55,0.85);
      color: #e5e7eb;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 2568</h1>
    <div class="filters">
      <div class="filter-group">
        <label for="startDatetime">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Start)</label>
        <input type="datetime-local" id="startDatetime" />
      </div>
      <div class="filter-group">
        <label for="endDatetime">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (End)</label>
        <input type="datetime-local" id="endDatetime" />
      </div>
      <div class="filter-group">
        <label for="licenseSelect">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
        <select id="licenseSelect">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="driverSelect">‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£</label>
        <select id="driverSelect">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="orgSelect">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
        <select id="orgSelect">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <button id="applyFilterBtn">Apply Filter</button>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <button id="resetFilterBtn" class="secondary">Reset</button>
      </div>
    </div>
  </header>

  <div id="map"></div>
  <div class="status-bar" id="statusBar">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*******************************
     * 1) CONFIG: Google Sheet ‡∏ä‡∏µ‡∏ï dataset
     *******************************/
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/1hjEeceDdHwOgZ4hbcE8bOfitZVhKB7KBtVHmF5p4iGY/export?format=csv&gid=365287996";

    // mapping ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ä‡∏µ‡∏ï dataset
    const COLUMN = {
      license: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",             // A
      datetime: "‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤",         // B
      lat: "‡∏•‡∏∞",                      // C
      lng: "‡∏•‡∏≠‡∏á",                     // D
      org: "‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î",                  // E
      distance: "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î", // F
      locationText: "‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà",    // G
      driver: "‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£"              // H
    };

    /*******************************
     * 2) ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
     *******************************/
    let rawData = [];
    let map, markersLayer;
    const licenseColorMap = {};

    const colorPalette = [
      "#ef4444", "#10b981", "#3b82f6", "#f97316", "#a855f7",
      "#22c55e", "#eab308", "#ec4899", "#14b8a6", "#6366f1",
      "#f59e0b", "#84cc16"
    ];

    function updateStatus(text) {
      document.getElementById("statusBar").textContent = text;
    }

    function getColorForLicense(license) {
      if (!licenseColorMap[license]) {
        const index = Object.keys(licenseColorMap).length % colorPalette.length;
        licenseColorMap[license] = colorPalette[index];
      }
      return licenseColorMap[license];
    }

    function parseDateTime(str) {
      if (!str) return null;
      // "2025-10-23 04:04:04" -> "2025-10-23T04:04:04"
      const iso = str.replace(" ", "T");
      const d = new Date(iso);
      return isNaN(d.getTime()) ? null : d;
    }

    function getFilteredData() {
      const startInput = document.getElementById("startDatetime").value;
      const endInput = document.getElementById("endDatetime").value;
      const licenseFilter = document.getElementById("licenseSelect").value;
      const driverFilter = document.getElementById("driverSelect").value;
      const orgFilter = document.getElementById("orgSelect").value;

      const start = startInput ? new Date(startInput) : null;
      const end = endInput ? new Date(endInput) : null;

      return rawData.filter(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return false;

        const dt = parseDateTime(row[COLUMN.datetime]);

        if (start && dt && dt < start) return false;
        if (end && dt && dt > end) return false;

        if (licenseFilter && row[COLUMN.license] !== licenseFilter) return false;
        if (driverFilter && row[COLUMN.driver] !== driverFilter) return false;
        if (orgFilter && row[COLUMN.org] !== orgFilter) return false;

        return true;
      });
    }

    function populateFilters() {
      const licenseSelect = document.getElementById("licenseSelect");
      const driverSelect = document.getElementById("driverSelect");
      const orgSelect = document.getElementById("orgSelect");

      const licenseSet = new Set();
      const driverSet = new Set();
      const orgSet = new Set();

      rawData.forEach(row => {
        if (row[COLUMN.license]) licenseSet.add(row[COLUMN.license]);
        if (row[COLUMN.driver]) driverSet.add(row[COLUMN.driver]);
        if (row[COLUMN.org]) orgSet.add(row[COLUMN.org]);
      });

      Array.from(licenseSet).sort().forEach(lic => {
        const opt = document.createElement("option");
        opt.value = lic;
        opt.textContent = lic;
        licenseSelect.appendChild(opt);
      });

      Array.from(driverSet).sort().forEach(drv => {
        const opt = document.createElement("option");
        opt.value = drv;
        opt.textContent = drv;
        driverSelect.appendChild(opt);
      });

      Array.from(orgSet).sort().forEach(org => {
        const opt = document.createElement("option");
        opt.value = org;
        opt.textContent = org;
        orgSelect.appendChild(opt);
      });
    }

    function resetFilters() {
      document.getElementById("startDatetime").value = "";
      document.getElementById("endDatetime").value = "";
      document.getElementById("licenseSelect").value = "";
      document.getElementById("driverSelect").value = "";
      document.getElementById("orgSelect").value = "";
    }

    function initMap() {
      // Center ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ ‡πÅ‡∏ñ‡∏ß‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå/‡∏≠‡∏µ‡∏™‡∏≤‡∏ô
      map = L.map("map").setView([16.3, 103.3], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    function renderMap() {
      markersLayer.clearLayers();
      const filtered = getFilteredData();

      if (filtered.length === 0) {
        updateStatus("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
      }

      const bounds = [];
      const legendDiv = document.querySelector(".legend-container");
      if (legendDiv) legendDiv.remove();

      const licensesInView = new Set();

      filtered.forEach(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return;

        const license = row[COLUMN.license] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
        const driver = row[COLUMN.driver] || "-";
        const datetime = row[COLUMN.datetime] || "-";
        const locationText = row[COLUMN.locationText] || "-";
        const distance = row[COLUMN.distance] || "-";
        const org = row[COLUMN.org] || "-";

        const color = getColorForLicense(license);
        licensesInView.add(license);

        const marker = L.circleMarker([lat, lng], {
          radius: 6,
          color: color,
          fillColor: color,
          fillOpacity: 0.9
        });

        const popupHtml = `
          <div style="font-size:12px;">
            <strong>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> ${license}<br/>
            <strong>‡∏û‡∏Ç‡∏£:</strong> ${driver}<br/>
            <strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${datetime}<br/>
            <strong>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</strong> ${org}<br/>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${locationText}<br/>
            <strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î:</strong> ${distance}<br/>
            <strong>Lat,Lng:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}
          </div>
        `;

        marker.bindPopup(popupHtml);
        marker.addTo(markersLayer);

        bounds.push([lat, lng]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      updateStatus(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á: ${filtered.length.toLocaleString()} ‡∏à‡∏∏‡∏î`);

      // legend ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
      const legend = L.control({ position: "topright" });
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend legend-container");
        div.innerHTML = "<strong>‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</strong><br/>";

        Array.from(licensesInView)
          .sort()
          .forEach(lic => {
            const color = getColorForLicense(lic);
            const row = document.createElement("div");
            row.className = "legend-item";
            const colorBox = document.createElement("span");
            colorBox.className = "legend-color";
            colorBox.style.backgroundColor = color;
            row.appendChild(colorBox);
            const text = document.createElement("span");
            text.textContent = lic;
            row.appendChild(text);
            div.appendChild(row);
          });

        return div;
      };
      legend.addTo(map);
    }

    function loadData() {
      updateStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...");

      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          rawData = results.data || [];
          updateStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${rawData.length.toLocaleString()} ‡πÅ‡∏ñ‡∏ß`);
          populateFilters();
          renderMap();
        },
        error: function (err) {
          console.error(err);
          updateStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();

      document
        .getElementById("applyFilterBtn")
        .addEventListener("click", () => renderMap());

      document
        .getElementById("resetFilterBtn")
        .addEventListener("click", () => {
          resetFilters();
          renderMap();
        });
    });
  </script>
</body>
</html>
