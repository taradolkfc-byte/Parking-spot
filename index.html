<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 2568</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    header {
      padding: 12px 16px;
      background: #1f2937;
      color: #fff;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .filter-group label {
      font-size: 11px;
      color: #e5e7eb;
    }
    .filter-group input,
    .filter-group select,
    .filter-group button {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #9ca3af;
    }
    .filter-group button {
      border: none;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
    .filter-group button.secondary {
      background: #6b7280;
    }

    #map {
      width: 100%;
      height: calc(100vh - 70px);
    }

    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.4;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 3px;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #4b5563;
    }

    .status-bar {
      position: absolute;
      z-index: 500;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(31,41,55,0.85);
      color: #e5e7eb;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 2568</h1>
    <div class="filters">
      <div class="filter-group">
        <label for="startDatetime">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Start)</label>
        <input type="datetime-local" id="startDatetime" />
      </div>
      <div class="filter-group">
        <label for="endDatetime">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (End)</label>
        <input type="datetime-local" id="endDatetime" />
      </div>
      <div class="filter-group">
        <label for="licenseSelect">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
        <select id="licenseSelect">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="driverSelect">‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£</label>
        <select id="driverSelect">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <button id="applyFilterBtn">Apply Filter</button>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <button id="resetFilterBtn" class="secondary">Reset</button>
      </div>
    </div>
  </header>

  <div id="map"></div>
  <div class="status-bar" id="statusBar">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*******************************
     * 1) CONFIG: Google Sheet ‡∏ä‡∏µ‡∏ï dataset
     *******************************/
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/1hjEeceDdHwOgZ4hbcE8bOfitZVhKB7KBtVHmF5p4iGY/export?format=csv&gid=365287996";

    const COLUMN = {
      license: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
      datetime: "‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤",
      lat: "‡∏•‡∏∞",
      lng: "‡∏•‡∏≠‡∏á",
      org: "‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î",
      distance: "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î",
      locationText: "‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà",
      driver: "‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£"
    };

    let rawData = [];
    let map, markersLayer;
    const licenseColorMap = {};

    const colorPalette = [
      "#ef4444",
      "#3b82f6",
      "#f97316",
      "#a855f7",
      "#eab308",
      "#ec4899",
      "#6366f1",
      "#f59e0b",
      "#fb7185"
    ];

    function updateStatus(text) {
      document.getElementById("statusBar").textContent = text;
    }

    function getColorForLicense(license) {
      if (!license) return "#000000";
      if (license === "70-2484-70") {
        licenseColorMap[license] = "#eab308"; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
        return "#eab308";
      }
      if (!licenseColorMap[license]) {
        const index = Object.keys(licenseColorMap).length % colorPalette.length;
        licenseColorMap[license] = colorPalette[index];
      }
      return licenseColorMap[license];
    }

    function parseDateTime(str) {
      if (!str) return null;
      const s = String(str).trim();
      const [datePart, timePart] = s.split(" ");
      if (!datePart || !timePart) return null;

      const [y, m, d] = datePart.split("-").map(Number);
      const [hh, mm = 0, ss = 0] = timePart.split(":").map(Number);
      if ([y, m, d].some(v => isNaN(v))) return null;
      return new Date(y, m - 1, d, hh || 0, mm || 0, ss || 0);
    }

    function haversineMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÇ‡∏ã‡∏ô‡πÑ‡∏ü‡πÅ‡∏î‡∏á
    const TRAFFIC_LIGHT_ZONES = [
      // { lat: 16.40075, lng: 103.36453, radiusMeters: 80 },
    ];

    function isInTrafficLightZone(lat, lng) {
      for (const z of TRAFFIC_LIGHT_ZONES) {
        const d = haversineMeters(lat, lng, z.lat, z.lng);
        if (d <= z.radiusMeters) return true;
      }
      return false;
    }

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô + ‡∏û‡∏Ç‡∏£ + ‡∏ï‡∏±‡∏î‡πÇ‡∏ã‡∏ô‡πÑ‡∏ü‡πÅ‡∏î‡∏á
    function getFilteredData() {
      const startInput = document.getElementById("startDatetime").value;
      const endInput = document.getElementById("endDatetime").value;
      const licenseFilter = document.getElementById("licenseSelect").value;
      const driverFilter = document.getElementById("driverSelect").value;

      const start = startInput ? new Date(startInput) : null;
      const end = endInput ? new Date(endInput) : null;

      return rawData.filter(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return false;
        if (isInTrafficLightZone(lat, lng)) return false;

        const dt = parseDateTime(row[COLUMN.datetime]);
        if ((start || end) && !dt) return false;
        if (start && dt < start) return false;
        if (end && dt > end) return false;

        if (licenseFilter && row[COLUMN.license] !== licenseFilter) return false;
        if (driverFilter && row[COLUMN.driver] !== driverFilter) return false;

        return true;
      });
    }

    // üîπ ‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏û‡∏Ç‡∏£.
    function updateLicenseOptionsByCurrentFilters() {
      const startInput = document.getElementById("startDatetime").value;
      const endInput = document.getElementById("endDatetime").value;
      const driverFilter = document.getElementById("driverSelect").value;
      const licenseSelect = document.getElementById("licenseSelect");

      const start = startInput ? new Date(startInput) : null;
      const end = endInput ? new Date(endInput) : null;

      const prevValue = licenseSelect.value;
      const licenseSet = new Set();

      rawData.forEach(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return;
        if (isInTrafficLightZone(lat, lng)) return;

        const dt = parseDateTime(row[COLUMN.datetime]);
        if ((start || end) && !dt) return;
        if (start && dt < start) return;
        if (end && dt > end) return;
        if (driverFilter && row[COLUMN.driver] !== driverFilter) return;

        if (row[COLUMN.license]) licenseSet.add(row[COLUMN.license]);
      });

      // ‡∏•‡πâ‡∏≤‡∏á option ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
      while (licenseSelect.options.length > 1) {
        licenseSelect.remove(1);
      }

      Array.from(licenseSet).sort().forEach(lic => {
        const opt = document.createElement("option");
        opt.value = lic;
        opt.textContent = lic;
        licenseSelect.appendChild(opt);
      });

      if (prevValue && licenseSet.has(prevValue)) {
        licenseSelect.value = prevValue;
      } else {
        licenseSelect.value = "";
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown "‡∏ä‡∏∑‡πà‡∏≠ ‡∏û‡∏Ç‡∏£" ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    function updateDriverOptionsByCurrentFilters() {
      const startInput = document.getElementById("startDatetime").value;
      const endInput = document.getElementById("endDatetime").value;
      const licenseFilter = document.getElementById("licenseSelect").value;
      const driverSelect = document.getElementById("driverSelect");

      const start = startInput ? new Date(startInput) : null;
      const end = endInput ? new Date(endInput) : null;

      const prevValue = driverSelect.value;
      const driverSet = new Set();

      rawData.forEach(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return;
        if (isInTrafficLightZone(lat, lng)) return;

        const dt = parseDateTime(row[COLUMN.datetime]);
        if ((start || end) && !dt) return;
        if (start && dt < start) return;
        if (end && dt > end) return;
        if (licenseFilter && row[COLUMN.license] !== licenseFilter) return;

        if (row[COLUMN.driver]) driverSet.add(row[COLUMN.driver]);
      });

      while (driverSelect.options.length > 1) {
        driverSelect.remove(1);
      }

      Array.from(driverSet).sort().forEach(drv => {
        const opt = document.createElement("option");
        opt.value = drv;
        opt.textContent = drv;
        driverSelect.appendChild(opt);
      });

      if (prevValue && driverSet.has(prevValue)) {
        driverSelect.value = prevValue;
      } else {
        driverSelect.value = "";
      }
    }

    function populateFilters() {
      // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ filter ‡∏≠‡∏∞‡πÑ‡∏£ ‚Üí ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞ ‡∏û‡∏Ç‡∏£. ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      updateLicenseOptionsByCurrentFilters();
      updateDriverOptionsByCurrentFilters();
    }

    function resetFilters() {
      document.getElementById("startDatetime").value = "";
      document.getElementById("endDatetime").value = "";
      document.getElementById("licenseSelect").value = "";
      document.getElementById("driverSelect").value = "";
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞ ‡∏û‡∏Ç‡∏£. ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      updateLicenseOptionsByCurrentFilters();
      updateDriverOptionsByCurrentFilters();
    }

    function initMap() {
      map = L.map("map").setView([16.3, 103.3], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function clusterByRadius(data, radiusMeters = 300) {
      const clusters = [];
      data.forEach(row => {
        const lat = parseFloat(row[COLUMN.lat]);
        const lng = parseFloat(row[COLUMN.lng]);
        if (isNaN(lat) || isNaN(lng)) return;

        let found = null;
        for (const cluster of clusters) {
          const d = haversineMeters(lat, lng, cluster.lat, cluster.lng);
          if (d <= radiusMeters) {
            found = cluster;
            break;
          }
        }

        if (found) {
          found.rows.push(row);
        } else {
          clusters.push({ lat, lng, rows: [row] });
        }
      });
      return clusters;
    }

    function renderMap() {
      markersLayer.clearLayers();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏û‡∏Ç‡∏£. ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö filter ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      updateLicenseOptionsByCurrentFilters();
      updateDriverOptionsByCurrentFilters();

      const filtered = getFilteredData();
      if (filtered.length === 0) {
        updateStatus("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
      }

      const clusters = clusterByRadius(filtered, 300);
      const bounds = [];
      const legendDiv = document.querySelector(".legend-container");
      if (legendDiv) legendDiv.remove();

      const licensesInView = new Set();
      let totalPoints = 0;

      clusters.forEach(cluster => {
        const { lat, lng, rows } = cluster;
        if (!rows.length) return;
        totalPoints += rows.length;

        const sortedRows = rows
          .map(r => ({ row: r, dt: parseDateTime(r[COLUMN.datetime]) }))
          .sort((a, b) => (a.dt || 0) - (b.dt || 0));

        const first = sortedRows[0].row;
        const last = sortedRows[sortedRows.length - 1].row;
        const startTime = first[COLUMN.datetime] || "-";
        const endTime = last[COLUMN.datetime] || "-";

        const licenseSet = new Set(rows.map(r => r[COLUMN.license]).filter(Boolean));
        const driverSet = new Set(rows.map(r => r[COLUMN.driver]).filter(Boolean));

        const licenseText = Array.from(licenseSet).join(", ") || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
        const driverText = Array.from(driverSet).join(", ") || "-";

        const locationText = first[COLUMN.locationText] || "-";
        const distance = first[COLUMN.distance] || "-";
        const org = first[COLUMN.org] || "-";

        const firstLicense = first[COLUMN.license] || licenseText;
        const color = getColorForLicense(firstLicense);
        licensesInView.add(firstLicense);

        const marker = L.circleMarker([lat, lng], {
          radius: 7,
          color: "#000000",
          weight: 1.5,
          fillColor: color,
          fillOpacity: 0.95
        });

        const popupHtml = `
          <div style="font-size:12px;">
            <strong>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> ${licenseText}<br/>
            <strong>‡∏û‡∏Ç‡∏£:</strong> ${driverText}<br/>
            <strong>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</strong> ${org}<br/>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${locationText}<br/>
            <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ:</strong> ${rows.length} ‡∏à‡∏∏‡∏î<br/>
            <strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</strong> ${startTime}<br/>
            <strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ${endTime}<br/>
            <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î:</strong> ${distance}<br/>
            <strong>Lat,Lng:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br/>
            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener noreferrer">
              ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
            </a>
          </div>
        `;

        marker.bindPopup(popupHtml);
        marker.addTo(markersLayer);
        bounds.push([lat, lng]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }

      updateStatus(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î: ${clusters.length.toLocaleString()} ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏£‡∏ß‡∏° ${totalPoints.toLocaleString()} ‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)`);

      const legend = L.control({ position: "topright" });
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend legend-container");
        div.innerHTML = "<strong>‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</strong><br/>";

        Array.from(licensesInView)
          .sort()
          .forEach(lic => {
            const color = getColorForLicense(lic);
            const row = document.createElement("div");
            row.className = "legend-item";
            const colorBox = document.createElement("span");
            colorBox.className = "legend-color";
            colorBox.style.backgroundColor = color;
            row.appendChild(colorBox);
            const text = document.createElement("span");
            text.textContent = lic;
            row.appendChild(text);
            div.appendChild(row);
          });

        return div;
      };
      legend.addTo(map);
    }

    function loadData() {
      updateStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...");

      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          rawData = results.data || [];
          updateStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${rawData.length.toLocaleString()} ‡πÅ‡∏ñ‡∏ß`);
          populateFilters();
          renderMap();
        },
        error: function (err) {
          console.error(err);
          updateStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();

      document
        .getElementById("applyFilterBtn")
        .addEventListener("click", () => renderMap());

      document
        .getElementById("resetFilterBtn")
        .addEventListener("click", () => {
          resetFilters();
          renderMap();
        });
    });
  </script>
</body>
</html>
